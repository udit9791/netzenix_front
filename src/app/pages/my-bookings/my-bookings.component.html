<div class="page-container">
<mat-card class="my-bookings-card">
  <mat-card-header>
    <mat-card-title>My Bookings</mat-card-title>
    <mat-card-subtitle>All your travel bookings</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <div class="toolbar">
      <!-- Master-only Tenant & Supplier Filters -->
      <div class="filters" *ngIf="showTenantFilter">
        <mat-form-field appearance="outline" subscriptSizing="dynamic" floatLabel="always" class="w-64 mr-4">
          <mat-label>Tenant</mat-label>
          <mat-select [formControl]="tenantCtrl">
            <mat-option [value]="null">All Tenants</mat-option>
            <mat-option *ngFor="let t of tenantOptions" [value]="t.id">
              {{ t.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic" floatLabel="always" class="w-64 mr-4">
          <mat-label>Supplier</mat-label>
          <mat-select [formControl]="supplierCtrl">
            <mat-option [value]="null">All Suppliers</mat-option>
            <mat-option *ngFor="let s of supplierOptions" [value]="s.id">
              {{ s.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Search</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Search bookings">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <button mat-raised-button color="primary">
        <mat-icon>filter_list</mat-icon>
        Filters
      </button>
    </div>

  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <div class="table-wrapper" *ngIf="!isLoading">
    <table mat-table [dataSource]="bookings" matSort class="full-width">
      
      <!-- Reference ID Column -->
      <ng-container matColumnDef="reference_id">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Reference ID </th>
        <td mat-cell *matCellDef="let booking"> {{booking.reference_id}} </td>
      </ng-container>

      <!-- Location/Sector Column -->
      <ng-container matColumnDef="location_sector">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Location/Sector </th>
        <td mat-cell *matCellDef="let booking"> {{booking.location_sector}} </td>
      </ng-container>

      <!-- Airline/Hotel Column -->
      <ng-container matColumnDef="airline_hotel">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Airline/Hotel </th>
        <td mat-cell *matCellDef="let booking"> {{booking.airline_hotel}} </td>
      </ng-container>

      <!-- Travel Mode Column -->
      <ng-container matColumnDef="travel_mode">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Travel Mode </th>
        <td mat-cell *matCellDef="let booking"> {{booking.travel_mode}} </td>
      </ng-container>

      <!-- Traveller Column -->
      <ng-container matColumnDef="traveller">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Traveller </th>
        <td mat-cell *matCellDef="let booking"> {{booking.traveller}} </td>
      </ng-container>

      <!-- Travel Date Column -->
      <ng-container matColumnDef="travel_date">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Travel Date </th>
        <td mat-cell *matCellDef="let booking"> {{booking.travel_date | date:'dd MMM yyyy'}} </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
        <td mat-cell *matCellDef="let booking"> 
          <span class="status-badge" [ngClass]="{
            'confirmed': booking.status === 1 || (booking.status_name?.toLowerCase() === 'confirmed'),
            'pending': booking.status === 0 || (booking.status_name?.toLowerCase() === 'pending'),
            'cancelled': booking.status === 2 || (booking.status_name?.toLowerCase() === 'cancelled'),
            'hold': booking.status === 8 || (booking.status_name?.toLowerCase() === 'hold'),
            'requested': booking.status === 11 || (booking.status_name?.toLowerCase() === 'requested')
          }">
            {{ booking.status_name || (booking.status === 1 ? 'Confirmed' : booking.status === 0 ? 'Pending' : booking.status === 2 ? 'Cancelled' : booking.status === 11 ? 'Requested' : 'Unknown') }}
          </span>
        </td>
      </ng-container>

      <!-- Total Fare Column -->
      <ng-container matColumnDef="total_fare">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Total Fare </th>
        <td mat-cell *matCellDef="let booking"> {{booking.total_fare | currency:'INR'}} </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Action </th>
        <td mat-cell *matCellDef="let booking">
          <button mat-icon-button color="primary" matTooltip="View Details" (click)="viewBooking(booking.reference_id)">
            <mat-icon>visibility</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons></mat-paginator>
  </div>
  
  </mat-card-content>
</mat-card>
</div>
