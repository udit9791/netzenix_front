<vex-secondary-toolbar [current]="activity?.title || 'Activity Detail'">
  <vex-breadcrumbs [crumbs]="['Activities', activity?.title || 'Detail']"></vex-breadcrumbs>
</vex-secondary-toolbar>

<vex-page-layout>
  <vex-page-layout-header>
    <div class="p-6 container">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-semibold mb-1">
            {{ activity?.title || 'Activity' }}
          </h1>
          <div class="flex flex-wrap gap-2 text-xs text-gray-700 mb-2">
            <span class="px-2 py-1 rounded-full bg-gray-100" *ngIf="activity?.has_time_slot">
              With time slots
            </span>
            <span class="px-2 py-1 rounded-full bg-gray-100" *ngIf="activity?.allow_child">
              Child allowed
            </span>
            <span class="px-2 py-1 rounded-full bg-gray-100" *ngIf="activity?.has_transportation">
              Includes transportation
            </span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon>place</mat-icon>
            <span>
              {{ activity?.city_id && activity?.city_name ? activity.city_name : '' }}
            </span>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button mat-icon-button>
            <mat-icon>favorite_border</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </vex-page-layout-header>

  <vex-page-layout-content>
    <div class="p-6 container">
      <mat-card>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2">
            <div class="flex flex-col lg:flex-row gap-3">
              <div class="flex-1">
                <img
                  class="w-full rounded-lg object-cover max-h-[360px] cursor-pointer"
                  [src]="primaryImage || fullImgUrl(null)"
                  [alt]="activity?.title || 'Activity'"
                  (click)="openImageSlider(0)" />
              </div>
              <div class="w-full lg:w-48 flex flex-col gap-2">
                <img
                  *ngFor="let img of galleryImages; let i = index"
                  class="w-full h-24 rounded-lg object-cover cursor-pointer"
                  [src]="img"
                  [alt]="activity?.title || 'Activity'"
                  (click)="openImageSlider(i + 1)" />
              </div>
            </div>
          </div>

          <div class="lg:col-span-1 border-t lg:border-t-0 lg:border-l border-gray-200 pt-4 lg:pt-0 lg:pl-4 flex flex-col justify-between">
            <div>
              <div class="text-sm text-gray-600 mb-1">
                From
              </div>
              <div class="text-3xl font-semibold text-gray-900 mb-2">
                ₹ {{ minPriceLabel }}
              </div>
              <div class="text-xs text-gray-500">
                Price per person
              </div>
            </div>
            <div class="mt-4 flex flex-col gap-2">
              <button mat-flat-button color="primary" class="w-full" (click)="selectOptions()">
                Select options
              </button>
              <button mat-stroked-button class="w-full" (click)="backToSearch()">
                Back to search
              </button>
            </div>
          </div>
        </div>

        <mat-divider class="my-6"></mat-divider>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">
            <div class="text-lg font-semibold mb-3">
              About this activity
            </div>
            <div class="text-sm text-gray-800 whitespace-pre-line">
              {{ activity?.description }}
            </div>
          </div>
          <div class="lg:col-span-1">
            <div class="text-sm font-semibold mb-2">
              Available dates
            </div>
            <div class="space-y-2 max-h-64 overflow-y-auto">
              <div
                class="border rounded px-3 py-2 text-xs flex items-center justify-between"
                *ngFor="let d of dates">
                <div>
                  <div class="font-medium">
                    {{ d.activity_date | date: 'dd MMM yyyy' }}
                  </div>
                  <div class="text-gray-500" *ngIf="d.pricing">
                    Adult: ₹{{ d.pricing.adult_price }} • Child: ₹{{ d.pricing.child_price }}
                  </div>
                </div>
                <div class="text-[10px] text-green-600" *ngIf="d.is_active">
                  Active
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-card>

      <div class="mt-4" *ngIf="loading">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>
      <div class="mt-4 text-red-600" *ngIf="!loading && error">
        {{ error }}
      </div>
    </div>
  </vex-page-layout-content>
</vex-page-layout>

<ng-template #packageOptionsTpl>
  <div class="p-4 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-3">
      <div class="font-medium text-base">Select date & quantity</div>
      <button mat-icon-button (click)="closePackageOptions()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <div class="text-sm text-gray-700 mb-2">Please select a visit date</div>
        <mat-card>
          <mat-calendar
            [dateFilter]="dateFilter"
            [(selected)]="selectedDate"
            (selectedChange)="onDateSelected($event)">
          </mat-calendar>
        </mat-card>
      </div>

      <div>
        <div class="text-sm text-gray-700 mb-2">Select options</div>
        <div *ngIf="selectedDateData; else noDateSelected">
          <div class="mb-3 text-xs text-gray-600">
            Selected: {{ selectedDate | date: 'dd MMM yyyy' }}
          </div>

          <ng-container *ngIf="hasTimeSlotForSelectedDate; else noTimeSlots">
            <div class="space-y-2">
              <div
                *ngFor="let slot of getSlotsForSelectedDate(); let i = index"
                class="flex items-center justify-between border rounded px-3 py-2"
                [class.border-blue-500]="i === selectedSlotIndex"
              >
                <div>
                  <div class="font-medium text-sm">
                    {{ formatSlotTime(slot.start_time) }} - {{ formatSlotTime(slot.end_time) }}
                  </div>
                  <div class="text-xs text-gray-600" *ngIf="slot.pricing">
                    Adult: ₹{{ slot.pricing.adult_price }}
                    <span *ngIf="slot.pricing.child_price != null">
                      • Child: ₹{{ slot.pricing.child_price }}
                    </span>
                  </div>
                </div>
                <button
                  mat-stroked-button
                  color="primary"
                  (click)="selectSlot(i)"
                >
                  {{ i === selectedSlotIndex ? 'Selected' : 'Select' }}
                </button>
              </div>
            </div>
          </ng-container>

          <ng-template #noTimeSlots>
            <div class="text-sm text-gray-600">
              No time slots for this date.
              <span *ngIf="selectedDateData?.pricing">
                Price:
                Adult: ₹{{ selectedDateData.pricing.adult_price }}
                <span *ngIf="selectedDateData.pricing.child_price != null">
                  • Child: ₹{{ selectedDateData.pricing.child_price }}
                </span>
              </span>
            </div>
          </ng-template>

          <div class="mt-4">
            <div class="text-sm font-medium mb-2">Select quantity</div>
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm font-medium">Adult</div>
                  <div class="text-xs text-gray-500">
                    <span *ngIf="maxAdults !== null">
                      Max {{ maxAdults }} per booking
                    </span>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button
                    mat-mini-fab
                    color="primary"
                    (click)="decrementAdult()"
                    [disabled]="adultCount <= 0">
                    <mat-icon>remove</mat-icon>
                  </button>
                  <div class="min-w-[2rem] text-center">
                    {{ adultCount }}
                  </div>
                  <button
                    mat-mini-fab
                    color="primary"
                    (click)="incrementAdult()">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
              </div>

              <div
                class="flex items-center justify-between"
                *ngIf="allowChild">
                <div>
                  <div class="text-sm font-medium">Child</div>
                  <div class="text-xs text-gray-500">
                    <span *ngIf="maxChildren !== null">
                      Max {{ maxChildren }} per booking
                    </span>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button
                    mat-mini-fab
                    color="primary"
                    (click)="decrementChild()"
                    [disabled]="childCount <= 0">
                    <mat-icon>remove</mat-icon>
                  </button>
                  <div class="min-w-[2rem] text-center">
                    {{ childCount }}
                  </div>
                  <button
                    mat-mini-fab
                    color="primary"
                    (click)="incrementChild()">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <ng-template #noDateSelected>
          <div class="text-sm text-gray-600">
            Please select a date from the calendar.
          </div>
        </ng-template>
      </div>
    </div>

    <div class="mt-4 flex justify-end gap-2">
      <button mat-stroked-button (click)="closePackageOptions()">Close</button>
      <button
        mat-flat-button
        color="primary"
        [disabled]="!isQuantityValid"
        (click)="confirmPackageSelection()">
        Continue
      </button>
    </div>
  </div>
</ng-template>

<ng-template #imageSliderTpl>
  <div class="p-4 w-full max-w-3xl max-h-[80vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-3">
      <div class="font-medium text-base">
        {{ activity?.title || 'Activity Photos' }}
      </div>
      <button mat-icon-button (click)="closeImageSlider()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="flex flex-col items-center gap-3">
      <img
        *ngIf="sliderImages.length"
        [src]="sliderImages[activeSliderIndex]"
        class="w-full max-h-[420px] object-cover rounded"
        [alt]="activity?.title || 'Activity'"
      />
      <div
        class="flex items-center justify-between w-full"
        *ngIf="sliderImages.length > 1"
      >
        <button mat-icon-button (click)="prevImage()">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <div class="text-xs text-gray-600">
          {{ activeSliderIndex + 1 }} / {{ sliderImages.length }}
        </div>
        <button mat-icon-button (click)="nextImage()">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
      <div
        class="flex gap-2 mt-2 w-full overflow-x-auto"
        *ngIf="sliderImages.length > 1"
      >
        <img
          *ngFor="let img of sliderImages; let i = index"
          [src]="img"
          (click)="activeSliderIndex = i"
          class="h-16 w-24 object-cover rounded border cursor-pointer"
          [class.border-blue-500]="i === activeSliderIndex"
          [alt]="activity?.title || 'Activity'"
        />
      </div>
    </div>
  </div>
</ng-template>
