<vex-page-layout>
  <vex-page-layout-header>
    <div class="flex items-center justify-between px-4 py-3">
      <vex-breadcrumbs
        [crumbs]="['Masters', 'Tenant Plans']"
      ></vex-breadcrumbs>
      <button mat-flat-button color="primary" (click)="openAddDialog()">
        <mat-icon>add</mat-icon>
        <span class="ml-2">Add Plan</span>
      </button>
    </div>
  </vex-page-layout-header>

  <vex-page-layout-content>
    <div class="p-4 space-y-4">
      <div class="flex flex-wrap gap-4 items-center">
        <mat-form-field appearance="outline">
          <mat-label>Search by name</mat-label>
          <input
            matInput
            [(ngModel)]="searchQuery"
            (keyup.enter)="applyFilter()"
            placeholder="Search plans"
          />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>User Type</mat-label>
          <mat-select
            [value]="userTypeFilter"
            (selectionChange)="onUserTypeFilterChange($event.value)"
          >
            <mat-option value="">All</mat-option>
            <mat-option value="buyer">Buyer</mat-option>
            <mat-option value="seller">Seller</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="relative">
        <table
          mat-table
          [dataSource]="dataSource"
          matSort
          (matSortChange)="onSortChange()"
          class="w-full"
        >
          <ng-container matColumnDef="tenant">
            <th mat-header-cell *matHeaderCellDef>Tenant</th>
            <td mat-cell *matCellDef="let row">
              {{ row.tenant?.name || '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Name
            </th>
            <td mat-cell *matCellDef="let row">
              {{ row.name }}
            </td>
          </ng-container>

          <ng-container matColumnDef="user_type">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              User Type
            </th>
            <td mat-cell *matCellDef="let row">
              {{ row.user_type | titlecase }}
            </td>
          </ng-container>

          <ng-container matColumnDef="price">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Price
            </th>
            <td mat-cell *matCellDef="let row">
              {{ row.price | number: '1.2-2' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="is_active">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let row">
              <mat-slide-toggle
                [checked]="!!row.is_active"
                (change)="toggleStatus(row)"
              >
              </mat-slide-toggle>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let row">
              <button
                mat-icon-button
                color="primary"
                (click)="openEditDialog(row)"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="deletePlan(row)"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
          ></tr>

          <tr class="mat-row" *matNoDataRow>
            <td
              class="mat-cell py-4 text-center"
              [attr.colspan]="displayedColumns.length"
            >
              <div
                *ngIf="isLoading"
                class="flex justify-center items-center p-4"
              >
                <mat-spinner diameter="40"></mat-spinner>
              </div>
              <div *ngIf="!isLoading">No plans found</div>
            </td>
          </tr>
        </table>

        <mat-paginator
          [length]="totalItems"
          [pageSize]="pageSize"
          [pageSizeOptions]="[5, 10, 25, 50]"
          (page)="onPageChange($event)"
        >
        </mat-paginator>
      </div>
    </div>

    <ng-template #planFormDialog>
      <h2 mat-dialog-title>
        {{ dialogMode === 'add' ? 'Add Plan' : 'Edit Plan' }}
      </h2>
      <mat-dialog-content>
        <form [formGroup]="planForm" class="space-y-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Name</mat-label>
            <input matInput formControlName="name" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>User Type</mat-label>
            <mat-select formControlName="user_type">
              <mat-option value="buyer">Buyer</mat-option>
              <mat-option value="seller">Seller</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Price</mat-label>
            <input matInput type="number" formControlName="price" />
          </mat-form-field>

          <mat-slide-toggle formControlName="is_active">
            Active
          </mat-slide-toggle>
        </form>
      </mat-dialog-content>
      <mat-dialog-actions align="end">
        <button mat-button mat-dialog-close>Cancel</button>
        <button mat-flat-button color="primary" (click)="savePlan()">
          Save
        </button>
      </mat-dialog-actions>
    </ng-template>
  </vex-page-layout-content>
</vex-page-layout>
