<vex-page-layout>
  <vex-page-layout-header>
    <div class="flex items-center justify-between px-4 py-3">
      <vex-breadcrumbs
        [crumbs]="['Masters', 'User Plans']"
      ></vex-breadcrumbs>
      <button mat-flat-button color="primary" (click)="openAddDialog()">
        <mat-icon>add</mat-icon>
        <span class="ml-2">Assign Plan</span>
      </button>
    </div>
  </vex-page-layout-header>

  <vex-page-layout-content>
    <div class="p-4 space-y-4">
      <div class="flex flex-wrap gap-4 items-center">
        <mat-form-field appearance="outline">
          <mat-label>Tenant</mat-label>
          <mat-select
            [ngModel]="selectedTenantId"
            (ngModelChange)="onTenantFilterChange($event)"
          >
            <mat-option [value]="null">All</mat-option>
            <mat-option
              *ngFor="let t of tenantOptions"
              [value]="t.id"
            >
              {{ t.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="relative">
        <table
          mat-table
          [dataSource]="dataSource"
          matSort
          (matSortChange)="onSortChange()"
          class="w-full"
        >
          <ng-container matColumnDef="tenant">
            <th mat-header-cell *matHeaderCellDef>Tenant</th>
            <td mat-cell *matCellDef="let row">
              {{ row.tenant?.name || '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="user">
            <th mat-header-cell *matHeaderCellDef>User</th>
            <td mat-cell *matCellDef="let row">
              {{ row.user?.name || '-' }}
              <span class="text-xs text-gray-500 ml-1">
                {{ row.user?.email }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="plan">
            <th mat-header-cell *matHeaderCellDef>Plan</th>
            <td mat-cell *matCellDef="let row">
              {{ row.plan?.name || '-' }}
              <span class="text-xs text-gray-500 ml-1">
                {{ row.plan?.user_type | titlecase }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="starts_at">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Starts At
            </th>
            <td mat-cell *matCellDef="let row">
              {{ row.starts_at | date: 'yyyy-MM-dd' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="ends_at">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Ends At
            </th>
            <td mat-cell *matCellDef="let row">
              {{ row.ends_at ? (row.ends_at | date: 'yyyy-MM-dd') : '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="is_active">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let row">
              <mat-slide-toggle
                [checked]="!!row.is_active"
                (change)="toggleStatus(row)"
              >
              </mat-slide-toggle>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let row">
              <button
                mat-icon-button
                color="primary"
                (click)="openEditDialog(row)"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="deleteSubscription(row)"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
          ></tr>

          <tr class="mat-row" *matNoDataRow>
            <td
              class="mat-cell py-4 text-center"
              [attr.colspan]="displayedColumns.length"
            >
              <div
                *ngIf="isLoading"
                class="flex justify-center items-center p-4"
              >
                <mat-spinner diameter="40"></mat-spinner>
              </div>
              <div *ngIf="!isLoading">No user plans found</div>
            </td>
          </tr>
        </table>

        <mat-paginator
          [length]="totalItems"
          [pageSize]="pageSize"
          [pageSizeOptions]="[5, 10, 25, 50]"
          (page)="onPageChange($event)"
        >
        </mat-paginator>
      </div>
    </div>

    <ng-template #subscriptionFormDialog>
      <h2 mat-dialog-title>
        {{ dialogMode === 'add' ? 'Assign Plan' : 'Edit User Plan' }}
      </h2>
      <mat-dialog-content>
        <form [formGroup]="subscriptionForm" class="space-y-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Tenant</mat-label>
            <mat-select formControlName="tenant_id" (selectionChange)="loadPlansForTenant()">
              <mat-option [value]="null">None</mat-option>
              <mat-option
                *ngFor="let t of tenantOptions"
                [value]="t.id"
              >
                {{ t.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>User</mat-label>
            <input
              matInput
              [(ngModel)]="userSearch"
              (keyup.enter)="searchUsers()"
              placeholder="Search user by name or email"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Select User</mat-label>
            <mat-select
              [ngModel]="selectedUser"
              (ngModelChange)="onUserSelected($event)"
            >
              <mat-option
                *ngFor="let u of userOptions"
                [value]="u"
              >
                {{ u.name }} ({{ u.email }})
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Plan</mat-label>
            <mat-select formControlName="tenant_user_plan_id">
              <mat-option
                *ngFor="let p of planOptions"
                [value]="p.id"
              >
                {{ p.name }} ({{ p.user_type | titlecase }} - {{
                  p.price | number: '1.2-2'
                }})
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Start Date</mat-label>
            <input
              matInput
              type="date"
              formControlName="starts_at"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>End Date</mat-label>
            <input
              matInput
              type="date"
              formControlName="ends_at"
            />
          </mat-form-field>

          <mat-slide-toggle formControlName="is_active">
            Active
          </mat-slide-toggle>
        </form>
      </mat-dialog-content>
      <mat-dialog-actions align="end">
        <button mat-button mat-dialog-close>Cancel</button>
        <button mat-flat-button color="primary" (click)="saveSubscription()">
          Save
        </button>
      </mat-dialog-actions>
    </ng-template>
  </vex-page-layout-content>
</vex-page-layout>
