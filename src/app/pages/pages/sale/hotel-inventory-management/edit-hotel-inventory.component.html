<vex-secondary-toolbar current="Edit Hotel Inventory">
  <vex-breadcrumbs [crumbs]="['Sale', 'Hotel Inventory Management', 'Edit']"></vex-breadcrumbs>
</vex-secondary-toolbar>

<div class="p-6 container">
  <div class="card p-4">
    <form [formGroup]="form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <mat-form-field appearance="outline">
        <mat-label>Country</mat-label>
        <mat-select formControlName="countryId" (selectionChange)="onCountryChange($event.value)">
          <mat-option *ngFor="let c of countries" [value]="c.id">{{ c.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>State</mat-label>
        <mat-select formControlName="stateId" (selectionChange)="onStateChange($event.value)">
          <mat-option *ngFor="let s of states" [value]="s.id">{{ s.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>City</mat-label>
        <mat-select formControlName="cityId" (selectionChange)="onCityChange($event.value)">
          <mat-option *ngFor="let ci of cities" [value]="ci.id">{{ ci.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Hotel</mat-label>
        <mat-select formControlName="hotelId" placeholder="Select hotel">
          <mat-option *ngFor="let h of hotels" [value]="h.id">{{ h.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Check-In Time</mat-label>
        <input matInput formControlName="checkinTime" placeholder="e.g., 14:00" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Check-Out Time</mat-label>
        <input matInput formControlName="checkoutTime" placeholder="e.g., 11:00" />
      </mat-form-field>

      <div class="md:col-span-2" *ngIf="hotelDetails">
        <div class="border rounded p-3">
          <div class="font-medium mb-2">Hotel Details</div>
          <div class="text-sm">Address: {{ hotelDetails?.address || hotelDetails?.location?.address || '-' }}</div>
          <div class="text-sm">City: {{ hotelDetails?.city_name || hotelDetails?.city || hotelDetails?.location?.city || '-' }}</div>
          <div class="text-sm">State: {{ hotelDetails?.state_name || hotelDetails?.state || hotelDetails?.location?.state || '-' }}</div>
          <div class="text-sm">Country: {{ hotelDetails?.country_name || hotelDetails?.country || hotelDetails?.location?.country || '-' }}</div>
        </div>
      </div>
    </form>
  </div>

  <div class="card p-4 mt-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="md:col-span-2 mt-2" [formGroup]="form">
        <div class="border rounded p-3">
          <div class="font-medium mb-3">Extra Bed Costs</div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4" formGroupName="extraCosts">
            <div class="grid grid-cols-2 gap-2">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Child Without Bed From (1–17)</mat-label>
                <mat-select formControlName="childAgeFrom">
                  <mat-option *ngFor="let a of ageOptions()" [value]="a">{{ a }}</mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>To</mat-label>
                <mat-select formControlName="childAgeTo">
                  <mat-option
                    *ngFor="let a of ageOptions()"
                    [value]="a"
                    [disabled]="a <= (form.get('extraCosts.childAgeFrom')?.value || 0)"
                  >
                    {{ a }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Child with Bed From (1–17)</mat-label>
                <mat-select formControlName="childWithBedAgeFrom">
                  <mat-option *ngFor="let a of ageOptions()" [value]="a">{{ a }}</mat-option>
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>To</mat-label>
                <mat-select formControlName="childWithBedAgeTo">
                  <mat-option
                    *ngFor="let a of ageOptions()"
                    [value]="a"
                    [disabled]="a <= (form.get('extraCosts.childWithBedAgeFrom')?.value || 0)"
                  >
                    {{ a }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <div formArrayName="roomDetails" class="space-y-4">
            <div
              *ngFor="let roomCtrl of roomDetails.controls; let i = index"
              [formGroupName]="i"
              class="border rounded p-3"
              [ngClass]="i % 2 === 0 ? 'bg-gray-50' : 'bg-white'"
            >
              <ng-container>
                <div class="font-medium mb-2 px-2 py-1 bg-gray-200 rounded">
                  {{ roomById(roomCtrl.get('roomId')?.value)?.room_name || ('Room ' + (i + 1)) }}
                </div>

                <div
                  class="mb-4"
                  formGroupName="extraCosts"
                  *ngIf="getSelectedMealKeys(roomCtrl.get('roomId')?.value)?.length"
                >
                  <div class="font-medium mb-2 px-2 py-1 bg-yellow-100 rounded">
                    Weekday Extra Bed Costs
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4" formGroupName="weekday">
                    <div class="border rounded" formGroupName="child">
                      <div class="p-2 font-medium">Extra Child Without Bed</div>
                      <table class="w-full border">
                        <thead>
                          <tr>
                            <th class="p-2 border">Meal</th>
                            <th class="p-2 border">Price</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr
                            *ngFor="
                              let mk of getSelectedMealKeys(roomCtrl.get('roomId')?.value);
                              trackBy: trackByMeal
                            "
                          >
                            <td class="p-2 border">{{ mk.label }}</td>
                            <td class="p-2 border">
                              <input
                                type="text"
                                inputmode="numeric"
                                class="pricing-input"
                                [formControlName]="mk.key"
                                (keydown)="onNumericKeydown($event)"
                                (input)="onNumericInput($event, roomExtraCostCtrl(roomCtrl.get('roomId')?.value, 'weekday', 'child', mk.key))"
                              />
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <div class="border rounded" formGroupName="child_with_bed">
                      <div class="p-2 font-medium">Extra Child with Bed</div>
                      <table class="w-full border">
                        <thead>
                          <tr>
                            <th class="p-2 border">Meal</th>
                            <th class="p-2 border">Price</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr
                            *ngFor="
                              let mk of getSelectedMealKeys(roomCtrl.get('roomId')?.value);
                              trackBy: trackByMeal
                            "
                          >
                            <td class="p-2 border">{{ mk.label }}</td>
                            <td class="p-2 border">
                              <input
                                type="text"
                                inputmode="numeric"
                                class="pricing-input"
                                [formControlName]="mk.key"
                                (keydown)="onNumericKeydown($event)"
                                (input)="onNumericInput($event, roomExtraCostCtrl(roomCtrl.get('roomId')?.value, 'weekday', 'child_with_bed', mk.key))"
                              />
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <div class="border rounded" formGroupName="adult">
                      <div class="p-2 font-medium">Extra Bed per Adult</div>
                      <table class="w-full border">
                        <thead>
                          <tr>
                            <th class="p-2 border">Meal</th>
                            <th class="p-2 border">Price</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr
                            *ngFor="
                              let mk of getSelectedMealKeys(roomCtrl.get('roomId')?.value);
                              trackBy: trackByMeal
                            "
                          >
                            <td class="p-2 border">{{ mk.label }}</td>
                            <td class="p-2 border">
                              <input
                                type="text"
                                inputmode="numeric"
                                class="pricing-input"
                                [formControlName]="mk.key"
                                (keydown)="onNumericKeydown($event)"
                                (input)="onNumericInput($event, roomExtraCostCtrl(roomCtrl.get('roomId')?.value, 'weekday', 'adult', mk.key))"
                              />
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div
                  *ngIf="getSelectedMealKeys(roomCtrl.get('roomId')?.value)?.length"
                  formGroupName="extraCosts"
                >
                  <div class="font-medium mb-2 px-2 py-1 bg-blue-100 rounded">
                    Week Off Days Extra Bed Costs
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4" formGroupName="weekend">
                    <div class="border rounded" formGroupName="child">
                      <div class="p-2 font-medium">Extra Child Without Bed</div>
                      <table class="w-full border">
                        <thead>
                          <tr>
                            <th class="p-2 border">Meal</th>
                            <th class="p-2 border">Price</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr
                            *ngFor="
                              let mk of getSelectedMealKeys(roomCtrl.get('roomId')?.value);
                              trackBy: trackByMeal
                            "
                          >
                            <td class="p-2 border">{{ mk.label }}</td>
                            <td class="p-2 border">
                              <input
                                type="text"
                                inputmode="numeric"
                                class="pricing-input"
                                [formControlName]="mk.key"
                                (keydown)="onNumericKeydown($event)"
                                (input)="onNumericInput($event, roomExtraCostCtrl(roomCtrl.get('roomId')?.value, 'weekend', 'child', mk.key))"
                              />
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <div class="border rounded" formGroupName="child_with_bed">
                      <div class="p-2 font-medium">Extra Child with Bed</div>
                      <table class="w-full border">
                        <thead>
                          <tr>
                            <th class="p-2 border">Meal</th>
                            <th class="p-2 border">Price</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr
                            *ngFor="
                              let mk of getSelectedMealKeys(roomCtrl.get('roomId')?.value);
                              trackBy: trackByMeal
                            "
                          >
                            <td class="p-2 border">{{ mk.label }}</td>
                            <td class="p-2 border">
                              <input
                                type="text"
                                inputmode="numeric"
                                class="pricing-input"
                                [formControlName]="mk.key"
                                (keydown)="onNumericKeydown($event)"
                                (input)="onNumericInput($event, roomExtraCostCtrl(roomCtrl.get('roomId')?.value, 'weekend', 'child_with_bed', mk.key))"
                              />
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <div class="border rounded" formGroupName="adult">
                      <div class="p-2 font-medium">Extra Bed per Adult</div>
                      <table class="w-full border">
                        <thead>
                          <tr>
                            <th class="p-2 border">Meal</th>
                            <th class="p-2 border">Price</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr
                            *ngFor="
                              let mk of getSelectedMealKeys(roomCtrl.get('roomId')?.value);
                              trackBy: trackByMeal
                            "
                          >
                            <td class="p-2 border">{{ mk.label }}</td>
                            <td class="p-2 border">
                              <input
                                type="text"
                                inputmode="numeric"
                                class="pricing-input"
                                [formControlName]="mk.key"
                                (keydown)="onNumericKeydown($event)"
                                (input)="onNumericInput($event, roomExtraCostCtrl(roomCtrl.get('roomId')?.value, 'weekend', 'adult', mk.key))"
                              />
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>

      <div class="md:col-span-2 border rounded p-3 mt-4" [formGroup]="form">
        <h3 class="text-base font-semibold">Refund Policy</h3>
        <div class="mb-4">
          <mat-radio-group formControlName="isRefundable" class="flex gap-4">
            <mat-radio-button value="refundable">Refundable</mat-radio-button>
            <mat-radio-button value="non-refundable">Non-Refundable</mat-radio-button>
          </mat-radio-group>
        </div>
        <div *ngIf="form.get('isRefundable')?.value === 'refundable'" class="mb-4">
          <h4 class="text-base font-medium mb-2">Fare Rules</h4>
          <div formArrayName="fareRules" class="border p-4 rounded-md bg-gray-50">
            <div
              *ngFor="let rule of fareRules.controls; let i = index"
              [formGroupName]="i"
              class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3 pb-3 border-b last:border-b-0 last:mb-0 last:pb-0"
            >
              <mat-form-field appearance="outline">
                <mat-label>Days before check-in</mat-label>
                <input matInput type="number" formControlName="days" min="1" />
                <mat-error *ngIf="fareRules.at(i).get('days')?.hasError('required')">Days is required</mat-error>
                <mat-error *ngIf="fareRules.at(i).get('days')?.hasError('min')">Must be at least 1 day</mat-error>
              </mat-form-field>
              <div class="flex items-center gap-2">
                <mat-form-field appearance="outline" class="flex-1">
                  <mat-label>Refundable Amount (₹)</mat-label>
                  <input matInput type="number" formControlName="amount" min="0" />
                  <mat-error *ngIf="fareRules.at(i).get('amount')?.hasError('required')">Amount is required</mat-error>
                  <mat-error *ngIf="fareRules.at(i).get('amount')?.hasError('min')">Amount cannot be negative</mat-error>
                </mat-form-field>
                <button mat-icon-button color="warn" type="button" (click)="removeFareRule(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            <div *ngIf="fareRules.length === 0" class="text-gray-500 italic text-center py-2">
              No refund rules added yet. Add at least one rule.
            </div>
            <div class="mt-3">
              <button mat-stroked-button color="primary" type="button" (click)="addFareRule()">
                <mat-icon>add</mat-icon> Add Refund Rule
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="md:col-span-2 border rounded p-3 mt-4" [formGroup]="form">
        <h3 class="text-base font-semibold">Hold Booking</h3>
        <div class="flex items-center">
          <mat-checkbox formControlName="allowHoldBooking">Allow Hold Booking</mat-checkbox>
        </div>

        <div *ngIf="form.get('allowHoldBooking')?.value" class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
          <mat-form-field appearance="outline">
            <mat-label>Amount Type</mat-label>
            <mat-select formControlName="holdBookingType">
              <mat-option value="percentage">Percentage</mat-option>
              <mat-option value="flat">Flat</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ form.get('holdBookingType')?.value === 'percentage' ? 'Hold Booking Percentage' : 'Hold Booking Amount' }}</mat-label>
            <input matInput type="number" formControlName="holdBookingAmount" min="0" />
            <mat-error *ngIf="form.get('holdBookingAmount')?.hasError('required')">
              {{ form.get('holdBookingType')?.value === 'percentage' ? 'Percentage' : 'Amount' }} is required
            </mat-error>
            <mat-error *ngIf="form.get('holdBookingAmount')?.hasError('min')">
              {{ form.get('holdBookingType')?.value === 'percentage' ? 'Percentage' : 'Amount' }} cannot be negative
            </mat-error>
            <mat-error *ngIf="form.get('holdBookingAmount')?.hasError('max')">Percentage cannot exceed 100%</mat-error>
            <mat-error *ngIf="form.get('holdBookingAmount')?.hasError('exceedsPrice')">Amount cannot exceed room price</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Hold Booking Cut-off (days)</mat-label>
            <input matInput type="number" formControlName="holdBookingCutOffDays" min="1" />
            <mat-error *ngIf="form.get('holdBookingCutOffDays')?.hasError('required')">Cut-off days is required</mat-error>
            <mat-error *ngIf="form.get('holdBookingCutOffDays')?.hasError('min')">Must be at least 1 day</mat-error>
            <mat-error *ngIf="form.get('holdBookingCutOffDays')?.hasError('maxDaysExceeded')">Cannot exceed 30 days</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Hold Booking Limit (hours)</mat-label>
            <input matInput type="number" formControlName="holdBookingLimit" min="1" />
            <mat-error *ngIf="form.get('holdBookingLimit')?.hasError('required')">Hold booking limit is required</mat-error>
            <mat-error *ngIf="form.get('holdBookingLimit')?.hasError('min')">Must be at least 1</mat-error>
            <mat-error *ngIf="form.get('holdBookingLimit')?.hasError('limitExceedsCutOff')">Cannot exceed hold booking cut-off hours</mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="md:col-span-2 mt-6" *ngIf="mode === 'normal'" [formGroup]="form">
        <div class="border rounded p-3">
          <div class="font-medium mb-3">Blackout Dates</div>
          <div class="flex items-center gap-2">
            <mat-form-field appearance="outline">
              <mat-label>Select Date</mat-label>
              <input
                matInput
                [matDatepicker]="blackoutPicker"
                formControlName="blackoutDateInput"
                [min]="minDate"
                (dateInput)="onBlackoutDateSelected($event.value)"
                (dateChange)="onBlackoutDateSelected($event.value)"
              />
              <mat-datepicker-toggle matSuffix [for]="blackoutPicker"></mat-datepicker-toggle>
              <mat-datepicker #blackoutPicker></mat-datepicker>
            </mat-form-field>
          </div>
          <div class="mt-2 flex flex-wrap gap-2" *ngIf="blackoutDates?.length">
            <div class="px-2 py-1 border rounded" *ngFor="let d of blackoutDates?.controls; let i = index">
              {{ formatDateStr(d.value) }}
              <button mat-icon-button color="warn" type="button" (click)="removeBlackoutDate(i)">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
          <div class="text-xs text-gray-600 mt-2">
            On blackout dates, rooms are considered unavailable for normal inventory.
          </div>
        </div>
      </div>

      <div class="md:col-span-2 mt-6 flex justify-end gap-2" [formGroup]="form">
        <button mat-stroked-button type="button" (click)="cancel()">Cancel</button>
        <button mat-flat-button color="primary" type="button" [disabled]="saving" (click)="save()">Save Inventory</button>
      </div>
    </div>
  </div>
</div>

