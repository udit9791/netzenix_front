<vex-secondary-toolbar current="Hotel Inventory Management">
  <vex-breadcrumbs [crumbs]="['Sale', 'Hotel Inventory Management']"></vex-breadcrumbs>
</vex-secondary-toolbar>

<div class="p-6 container">
  <div class="card flex-auto">
    <div class="flex flex-wrap items-end gap-4 p-4">
      <form [formGroup]="filterForm" class="flex flex-wrap items-end gap-4 flex-1">
        <mat-form-field appearance="outline" class="w-64">
          <mat-label>Search</mat-label>
          <input matInput formControlName="search" (keyup.enter)="loadInventory()" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-48">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option value="">All</mat-option>
            <mat-option value="active">Active</mat-option>
            <mat-option value="inactive">Inactive</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="w-64" *ngIf="showTenantFilter">
          <mat-label>Tenant</mat-label>
          <mat-select formControlName="tenantId">
            <mat-option [value]="null">All Tenants</mat-option>
            <mat-option *ngFor="let t of tenantOptions" [value]="t.id">
              {{ t.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="w-64" *ngIf="showSupplierFilter">
          <mat-label>Supplier</mat-label>
          <mat-select formControlName="supplierId">
            <mat-option [value]="null">All Suppliers</mat-option>
            <mat-option *ngFor="let s of supplierOptions" [value]="s.id">
              {{ s.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </form>

      <div class="flex items-center gap-2 ml-auto">
        <button mat-flat-button color="primary" (click)="loadInventory()">Refresh Inventory</button>
        <button mat-flat-button color="primary" [routerLink]="['/sale/hotel-inventory-management/add']" [queryParams]="{ type: currentType }">+ Add Inventory</button>
      </div>
    </div>
  </div>

  <div class="overflow-auto">
    <table mat-table [dataSource]="dataSource" matSort class="w-full">
      <ng-container matColumnDef="hotel">
        <th mat-header-cell *matHeaderCellDef>Hotel</th>
        <td mat-cell *matCellDef="let row">{{ row.hotel_name }}</td>
      </ng-container>

      <ng-container matColumnDef="checkIn">
        <th mat-header-cell *matHeaderCellDef>Check In</th>
        <td mat-cell *matCellDef="let row">{{ row.check_in_time }}</td>
      </ng-container>

      <ng-container matColumnDef="checkOut">
        <th mat-header-cell *matHeaderCellDef>Check Out</th>
        <td mat-cell *matCellDef="let row">{{ row.check_out_time }}</td>
      </ng-container>

      <ng-container matColumnDef="address">
        <th mat-header-cell *matHeaderCellDef>Address</th>
        <td mat-cell *matCellDef="let row">{{ row.address || '-' }}</td>
      </ng-container>

      <ng-container matColumnDef="tax">
        <th mat-header-cell *matHeaderCellDef>Tax</th>
        <td mat-cell *matCellDef="let row">
          <span *ngIf="isSameState">CGST + SGST</span>
          <span *ngIf="!isSameState">IGST</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="ranges">
        <th mat-header-cell *matHeaderCellDef>Date Ranges</th>
        <td mat-cell *matCellDef="let row">
          <span *ngIf="row.ranges?.length === 0">-</span>
          <span *ngFor="let rg of row.ranges; let i = index">
            {{ rg.start_date | date:'dd-MM-yyyy' }} to {{ rg.end_date | date:'dd-MM-yyyy' }}<span *ngIf="i < row.ranges.length - 1">, </span>
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let row">
         
          <button mat-stroked-button color="accent" class="ml-2" (click)="onToggleStatus(row)">
            {{ row.is_active ? 'Active' : 'Inactive' }}
          </button>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let row">
          <button mat-stroked-button color="primary" (click)="onEdit(row)" matTooltip="Edit inventory">
            <mat-icon class="mr-1">edit</mat-icon>
          </button>
          <button *ngIf="currentType === 'normal'" mat-stroked-button color="primary" class="ml-2" (click)="openImportDates(importDatesTpl, row)" matTooltip="Import dates">
            <mat-icon class="mr-1">file_upload</mat-icon>
            Import Dates
          </button>
          <button mat-stroked-button color="primary" class="ml-2" (click)="onEditDates(row)" matTooltip="Edit dates">
            <mat-icon class="mr-1">date_range</mat-icon>
          </button>
          <button mat-stroked-button color="primary" class="ml-2" (click)="onUpdatePricing(row)" matTooltip="Edit price">
            <mat-icon class="mr-1">attach_money</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="visibleColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: visibleColumns"></tr>
    </table>
    <mat-paginator [pageSize]="pageSize" [pageIndex]="pageIndex" [pageSizeOptions]="pageSizeOptions" (page)="onPageChange($event)"></mat-paginator>
  </div>
</div>
<ng-template #importDatesTpl>
  <div class="p-4 w-[520px]">
    <div class="text-lg font-medium mb-2">Import Dates</div>
    <div class="text-sm mb-3">Upload CSV per room (date,no_of_room or room_id,date,no_of_room)</div>
    <div *ngFor="let r of roomsForImport" class="mb-4 border rounded p-3">
      <div class="font-medium mb-2">Room {{ r.room_name || r.room_id }}</div>
      <div class="mb-2">
        <input type="file" (change)="onSelectRoomImportFile(r.room_id, $event)" accept=".csv,text/csv" />
      </div>
      <div class="flex gap-2">
        <a mat-stroked-button [href]="publicBaseUrl + 'sample_csv/no_of_rooms.csv'" target="_blank" rel="noopener">Download Sample</a>
      </div>
      <div class="text-red-600 mt-2" *ngIf="roomImportErrors[r.room_id]">{{ roomImportErrors[r.room_id] }}</div>
      <div class="mt-3 flex gap-2">
        <button mat-flat-button color="primary" type="button" (click)="submitRoomImport(r.room_id)" [disabled]="!roomImportFiles[r.room_id] || roomImporting[r.room_id]">Submit</button>
        <button mat-button type="button" (click)="closeImportDialog()">Close</button>
      </div>
    </div>
    <div class="flex gap-2">
      <button mat-button type="button" (click)="closeImportDialog()">Close</button>
    </div>
  </div>
</ng-template>
