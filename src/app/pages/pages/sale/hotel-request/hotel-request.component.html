<vex-secondary-toolbar current="Hotel Request">
  <vex-breadcrumbs [crumbs]="['Sale', 'Hotel Request']"></vex-breadcrumbs>
</vex-secondary-toolbar>

<div class="page-container p-6">
  <mat-card class="hotel-requests-card">
    <mat-card-header>
      <mat-card-title>Hotel Requests</mat-card-title>
      <mat-card-subtitle>Requested hotel bookings</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="toolbar">
        <div class="filters" *ngIf="isAdmin">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" floatLabel="always" class="w-64 mr-4">
            <mat-label>Tenant</mat-label>
            <mat-select [formControl]="tenantCtrl">
              <mat-option [value]="null">All Tenants</mat-option>
              <mat-option *ngFor="let t of tenantOptions" [value]="t.id">
                {{ t.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic" floatLabel="always" class="w-64 mr-4">
            <mat-label>Supplier</mat-label>
            <mat-select [formControl]="supplierCtrl">
              <mat-option [value]="null">All Suppliers</mat-option>
              <mat-option *ngFor="let s of supplierOptions" [value]="s.id">
                {{ s.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline">
          <mat-label>Search</mat-label>
          <input matInput placeholder="Search requests">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>

      <div class="loading-container" *ngIf="isLoading">
        <mat-spinner diameter="40"></mat-spinner>
      </div>

      <div class="table-wrapper" *ngIf="!isLoading">
        <table mat-table [dataSource]="requests" matSort class="full-width">
          <ng-container matColumnDef="reference_id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Reference ID </th>
            <td mat-cell *matCellDef="let r"> {{r.reference_id}} </td>
          </ng-container>

          <ng-container matColumnDef="hotel">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Hotel </th>
            <td mat-cell *matCellDef="let r"> {{r.hotel}} </td>
          </ng-container>

          <ng-container matColumnDef="traveller">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Traveller </th>
            <td mat-cell *matCellDef="let r"> {{r.traveller}} </td>
          </ng-container>

          <ng-container matColumnDef="check_in">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Check-In </th>
            <td mat-cell *matCellDef="let r"> {{r.check_in | date:'dd MMM yyyy'}} </td>
          </ng-container>

          <ng-container matColumnDef="check_out">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Check-Out </th>
            <td mat-cell *matCellDef="let r"> {{r.check_out | date:'dd MMM yyyy'}} </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
            <td mat-cell *matCellDef="let r"> 
              <span class="status-badge" [ngClass]="{
                'requested': r.status === 11 || (r.status_name?.toLowerCase() === 'requested')
              }">
                {{ r.status_name || (r.status === 11 ? 'Requested' : 'Unknown') }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="total_fare">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Total Fare </th>
            <td mat-cell *matCellDef="let r"> {{r.total_fare | currency:'INR'}} </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Action </th>
            <td mat-cell *matCellDef="let r">
              <button mat-icon-button color="primary" matTooltip="View Details" (click)="viewBooking(r.reference_id)">
                <mat-icon>visibility</mat-icon>
              </button>
              <ng-container *ngIf="r.status == 11">
                <button mat-stroked-button color="primary" class="mr-2" (click)="onConfirm(r.reference_id)" [disabled]="processingId === r.reference_id">
                  <mat-icon class="mr-1">check_circle</mat-icon>
                  Confirm
                </button>
                <button mat-stroked-button color="warn" (click)="onDecline(r.reference_id)" [disabled]="processingId === r.reference_id">
                  <mat-icon class="mr-1">cancel</mat-icon>
                  Decline
                </button>
              </ng-container>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</div>
