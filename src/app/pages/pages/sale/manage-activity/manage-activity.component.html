<vex-secondary-toolbar [current]="isEditMode ? 'Edit Activity' : 'Add Activity'">
  <vex-breadcrumbs [crumbs]="['Sale', isEditMode ? 'Edit Activity' : 'Add Activity']"></vex-breadcrumbs>
</vex-secondary-toolbar>

<div class="p-6 container">
  <form [formGroup]="activityForm" (ngSubmit)="submit()" class="grid gap-6">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Basic Information</mat-card-title>
      </mat-card-header>
      <mat-card-content class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <mat-form-field appearance="outline">
          <mat-label>Country</mat-label>
          <mat-select formControlName="country_id" required>
            <mat-option [value]="null">Select Country</mat-option>
            <mat-option *ngFor="let c of countries" [value]="c.id">
              {{ c.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>State</mat-label>
          <mat-select formControlName="state_id" required>
            <mat-option *ngFor="let s of states" [value]="s.id">
              {{ s.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>City</mat-label>
          <mat-select formControlName="city_id" required>
            <mat-option *ngFor="let c of cities" [value]="c.id">
              {{ c.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="md:col-span-3">
          <mat-label>Activity Title</mat-label>
          <input matInput formControlName="title" maxlength="255" />
        </mat-form-field>

        <div class="md:col-span-3">
          <label class="block mb-2 text-sm font-medium">Description</label>
          <textarea
            class="w-full border rounded px-3 py-2"
            rows="5"
            formControlName="description"
          ></textarea>
        </div>

        <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-2 text-sm font-medium">Cover Image</label>
            <input type="file" accept="image/jpeg,image/png" (change)="onCoverImageChange($event)" />
            <div class="mt-2 w-24 h-24 rounded overflow-hidden border" *ngIf="coverPreviewUrl || currentCoverImagePath">
              <img
                [src]="coverPreviewUrl || (imgBaseUrl + currentCoverImagePath)"
                class="w-full h-full object-cover"
                alt="Cover image"
              />
            </div>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium">Gallery Images</label>
            <input type="file" multiple accept="image/jpeg,image/png" (change)="onImagesChange($event)" />
            <div class="mt-2 flex flex-wrap gap-2">
              <div
                *ngFor="let img of existingImages"
                class="relative w-24 h-24 rounded overflow-hidden border"
              >
                <img
                  [src]="imgBaseUrl + img.image_path"
                  class="w-full h-full object-cover"
                  alt="Gallery image"
                />
                <button
                  type="button"
                  mat-icon-button
                  color="warn"
                  class="absolute top-0 right-0 bg-white/70"
                  (click)="removeExistingImage(img)"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              <div
                *ngFor="let preview of galleryPreviews; let i = index"
                class="relative w-24 h-24 rounded overflow-hidden border"
              >
                <img
                  [src]="preview.url"
                  class="w-full h-full object-cover"
                  alt="New gallery image"
                />
                <button
                  type="button"
                  mat-icon-button
                  color="warn"
                  class="absolute top-0 right-0 bg-white/70"
                  (click)="removeNewImage(i)"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>Activity Rules</mat-card-title>
      </mat-card-header>
      <mat-card-content class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 items-center">
        <mat-checkbox formControlName="has_time_slot">
          Has Time Slot
        </mat-checkbox>

        <mat-form-field appearance="outline">
          <mat-label>Max Adults</mat-label>
          <input matInput type="number" formControlName="max_adults" min="1" />
        </mat-form-field>

        <mat-checkbox formControlName="allow_child">
          Allow Child
        </mat-checkbox>

        <mat-form-field appearance="outline">
          <mat-label>Max Children</mat-label>
          <input matInput type="number" formControlName="max_children" min="0" />
        </mat-form-field>

        <mat-checkbox formControlName="has_transportation">
          Has Transportation
        </mat-checkbox>

        <mat-form-field appearance="outline" class="md:col-span-3">
          <mat-label>Transportation Description</mat-label>
          <textarea
            matInput
            rows="3"
            formControlName="transportation_description"
          ></textarea>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>Availability & Pricing</mat-card-title>
      </mat-card-header>
      <mat-card-content class="grid gap-4 mt-4">
        <div class="flex justify-between items-center">
          <div>
            <div class="text-sm text-gray-600">
              Minimum date is today. Add one or more dates.
            </div>
          </div>
          <!-- <button mat-stroked-button color="primary" type="button" (click)="addDate()">
            <mat-icon>add</mat-icon>
            <span class="ml-1">Add Date</span>
          </button> -->
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-medium mb-2">
              select a date range
            </div>
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Date range</mat-label>
              <mat-date-range-input [rangePicker]="rangePicker">
                <input
                  matStartDate
                  matInput
                  placeholder="Start date"
                  formControlName="rangeStart"
                  [min]="minDate"
                  (dateChange)="onRangeChange()"
                />
                <input
                  matEndDate
                  matInput
                  placeholder="End date"
                  formControlName="rangeEnd"
                  [min]="minDate"
                  (dateChange)="onRangeChange()"
                />
              </mat-date-range-input>
              <mat-datepicker-toggle matSuffix [for]="rangePicker"></mat-datepicker-toggle>
              <mat-date-range-picker #rangePicker></mat-date-range-picker>
            </mat-form-field>
          </div>
        </div>

        <div formArrayName="dates" class="grid gap-4">
          <div
            *ngFor="let dateGroup of dates.controls; let i = index"
            [formGroupName]="i"
            class="border rounded p-4 grid gap-4"
          >
            <div class="flex items-center gap-4">
              <mat-form-field appearance="outline">
                <mat-label>Date</mat-label>
                <input
                  matInput
                  [matDatepicker]="picker"
                  formControlName="date"
                  [min]="minDate"
                />
                <mat-datepicker-toggle
                  matSuffix
                  [for]="picker"
                ></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>

              <button
                *ngIf="!dateGroup.get('id')?.value"
                mat-icon-button
                color="warn"
                type="button"
                (click)="removeDate(i)"
                [disabled]="dates.length === 1"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <ng-container *ngIf="!hasTimeSlot()">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <mat-form-field appearance="outline">
                  <mat-label>Adult Price</mat-label>
                  <input matInput type="number" formControlName="adult_price" min="0" />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Child Price</mat-label>
                  <input matInput type="number" formControlName="child_price" min="0" />
                </mat-form-field>
                <div *ngIf="i === 0 && dates.length > 1" class="flex items-center">
                  <mat-checkbox (change)="applyPricesToAllDates()">
                    Apply to all dates
                  </mat-checkbox>
                </div>
              </div>
            </ng-container>

            <ng-container *ngIf="hasTimeSlot()">
              <div formArrayName="slots" class="grid gap-3">
                <div class="flex justify-between items-center mb-2">
                  <div class="font-medium text-sm">Time Slots</div>
                  <div class="flex items-center gap-3">
                    <button
                      mat-stroked-button
                      color="primary"
                      type="button"
                      (click)="addSlot(i)"
                    >
                      <mat-icon>add</mat-icon>
                      <span class="ml-1">Add Slot</span>
                    </button>
                    <mat-checkbox *ngIf="i === 0 && dates.length > 1" (change)="applySlotsToAllDates()">
                      Apply slots to all dates
                    </mat-checkbox>
                  </div>
                </div>

                <div
                  *ngFor="let slot of getSlots(i).controls; let j = index"
                  [formGroupName]="j"
                  class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end"
                >
                  <mat-form-field appearance="outline">
                    <mat-label>Start Time</mat-label>
                    <mat-select formControlName="start_time">
                      <mat-option *ngFor="let t of timeOptions" [value]="t">
                        {{ t }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>End Time</mat-label>
                    <mat-select formControlName="end_time">
                      <mat-option *ngFor="let t of getEndTimeOptions(i, j)" [value]="t">
                        {{ t }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Max Capacity</mat-label>
                    <input
                      matInput
                      type="number"
                      formControlName="max_capacity"
                      min="1"
                    />
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Adult Price</mat-label>
                    <input matInput type="number" formControlName="adult_price" min="0" />
                  </mat-form-field>

                  <div class="flex items-center gap-2">
                    <mat-form-field appearance="outline" class="flex-1">
                      <mat-label>Child Price</mat-label>
                      <input
                        matInput
                        type="number"
                        formControlName="child_price"
                        min="0"
                      />
                    </mat-form-field>
                    <button
                      *ngIf="!slot.get('id')?.value"
                      mat-icon-button
                      color="warn"
                      type="button"
                      (click)="removeSlot(i, j)"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="flex justify-end">
      <button mat-flat-button color="primary" type="submit">
        <mat-icon>save</mat-icon>
        <span class="ml-1">Save Activity</span>
      </button>
    </div>
  </form>
</div>
